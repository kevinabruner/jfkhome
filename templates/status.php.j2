<?php
$stats_url = "{{ proxy_stats_url }}";
$stats_json = file_get_contents($stats_url);
$stats = $stats_json ? json_decode($stats_json, true) : [];
$meta_raw = @file_get_contents('/var/www/html/services_meta.json');
$metadata = json_decode($meta_raw, true) ?? [];
$rendered_backends = [];    

// Helper to clean up the nested HAProxy 2.x structure safely
function flatten_row($row) {
    $flat = [];
    foreach ($row as $field_obj) {
        // Safety check: ensure the keys exist before accessing them
        if (isset($field_obj['field']['name']) && isset($field_obj['value']['value'])) {
            $flat[$field_obj['field']['name']] = $field_obj['value']['value'];
        }
    }
    return $flat;
}

// Status checker for backends with service file definitions in the reverse_proxy repo
function get_backend_info($svc_name, $all_stats, $service_type) {    
    global $rendered_backends;    
    $target_px = $svc_name . "_backend";

    $info = $metadata[$target_px] ?? [
        'url' => '#', 
        'desc' => 'Service metadata missing'
    ];

    foreach ($all_stats as $row) {
        $data = flatten_row($row);
        if (
            isset($data['pxname']) && 
            $data['pxname'] === $target_px && 
            isset($data['svname']) && 
            $data['svname'] === 'BACKEND'
        ) 
        {            
            //If the service type is web, add to rendered backends (Any web service not in this array will be hidden)
            if ($service_type == "web") {
                $rendered_backends[] = $target_px; 
                $raw_desc = $data['desc'] ?? '|'; 
                $parts = explode('|', $raw_desc, 2);
            }

            //returns the status, if it exists
            return [
                'status' => strtolower($data['status'] ?? 'unknown'),
                'url'    => $info['url'],
                'desc'   => $info['desc']
            ];        
        }
    }
    return null;
}
// Temporary debug:
 print_r(flatten_row($all_stats[0]));

