<?php
$stats_url = "{{ proxy_stats_url }}";
$stats_json = @file_get_contents($stats_url);
$stats = $stats_json ? json_decode($stats_json, true) : [];

$rendered_backends = []; // Track what we've shown

// Helper to clean up the nested HAProxy 2.x structure safely
function flatten_row($row) {
    $flat = [];
    foreach ($row as $field_obj) {
        // Safety check: ensure the keys exist before accessing them
        if (isset($field_obj['field']['name']) && isset($field_obj['value']['value'])) {
            $flat[$field_obj['field']['name']] = $field_obj['value']['value'];
        }
    }
    return $flat;
}

// Single version of the status checker
function get_backend_status($svc_name, $all_stats) {
    global $rendered_backends;
    $target_px = $svc_name . "_backend";
    
    foreach ($all_stats as $row) {
        $data = flatten_row($row);
        if (isset($data['pxname']) && $data['pxname'] === $target_px && isset($data['svname']) && $data['svname'] === 'BACKEND') {
            $rendered_backends[] = $target_px; 
            return isset($data['status']) ? strtolower($data['status']) : 'unknown';
        }
    }
    return 'unknown';
}

// Version for the DBs (handles raw names like psql_backend)
function get_backend_status_raw($target_px, $all_stats) {
    foreach ($all_stats as $row) {
        $data = flatten_row($row);
        if (isset($data['pxname']) && $data['pxname'] === $target_px && isset($data['svname']) && $data['svname'] === 'BACKEND') {
            return isset($data['status']) ? strtolower($data['status']) : 'unknown';
        }
    }
    return 'unknown';
}
?>