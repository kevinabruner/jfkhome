<?php
$stats_url = "{{ proxy_stats_url }}";
$stats_json = file_get_contents($stats_url);
$raw_stats = $stats_json ? json_decode($stats_json, true) : [];

$meta_raw = @file_get_contents('/var/www/html/services_meta.json');
$metadata = json_decode($meta_raw, true) ?? [];

// 1. Process the raw stream into a usable lookup table
$processed_stats = [];
foreach ($raw_stats as $item) {
    // We only care about objects that have a proxyName (Backends/Frontends/Servers)
    if (isset($item['proxyName'])) {
        $px = $item['proxyName'];
        $sv = $item['serviceName'] ?? 'BACKEND';
        $fieldName = $item['field']['name'] ?? null;
        $val = $item['value']['value'] ?? null;

        if ($fieldName) {
            $processed_stats[$px][$sv][$fieldName] = $val;
        }
    }
}

// 2. Updated checker using our new lookup table
function get_backend_info($svc_name, $service_type) {    
    global $rendered_backends, $processed_stats, $metadata;    
    $target_px = $svc_name . "_backend";

    // Grab metadata from your Ansible sidecar
    $info = $metadata[$target_px] ?? [
        'url' => '#', 
        'desc' => 'Service metadata missing'
    ];

    // Check if we have live data for this backend's summary row
    if (isset($processed_stats[$target_px]['BACKEND'])) {
        $data = $processed_stats[$target_px]['BACKEND'];

        if ($service_type == "web") {
            $rendered_backends[] = $target_px;
        }

        return [
            'status' => strtolower($data['status'] ?? 'unknown'),
            'url'    => $info['url'],
            'desc'   => $info['desc']
        ];        
    }
    
    return null;
}

// Example usage:
// $status = get_backend_info('koscinski', 'web');