{# Define scope #}
{%- set scope = 'external' if env == 'prod' else 'internal' -%}

{# Include a script to parse the haproxy json information #}
<?php include 'status.php';?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Service Directory - {{ env | upper }}</title>
    <link rel="stylesheet" type="text/css" href="./style.css">  
</head>
<body>
    <div class="container">
        <h1>TheJFK.ca Service Directory</h1>
        <p>Environment: <strong>{{ env }}</strong> | <small>Live Status: <?php echo empty($stats) ? '⚠️ Offline' : '✅ Connected'; ?></small></p>
        
        {% for svc in services_list | sort(attribute='name') %}

            {# 1. Filter for scope (internal/external) and visibility (not intentionally hidden) #}
            {% if scope in svc.scope and not svc.hide_on_page | default(false) %}
                
                <?php 
                // 2. Perform the live HAProxy lookup
                $status = get_backend_status('{{ svc.name }}', $stats); 
                
                // 3. Only render the HTML if the backend was actually found
                if ($status !== 'unknown'): 
                ?>
                
                <div class="service-card">
                    <div style="display: flex; align-items: center; min-width: 200px;">
                        <span class="status-dot status-<?php echo $status; ?>" title="Status: <?php echo strtoupper($status); ?>"></span>
                        <div>
                            <span class="service-name">{{ svc.name | replace('_', ' ') | title }}</span>
                            <br>
                            {%- for target_scope in svc.scope %}
                            <span class="tag tag_{{ target_scope }}">{{ target_scope }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="desc">
                        {{ svc.description | default(" ") }}
                    </div>

                    <div>
                        <a href="https://{{ svc.fqdn_list | first }}" class="btn" target="_blank">View site</a>
                    </div>
                </div>

                <?php endif; // End status check ?>
            {% endif %}
        {% endfor %}
    </div>
</body>
</html>